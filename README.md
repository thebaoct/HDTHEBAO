<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool In H√≥a ƒê∆°n - THE B√ÅO V3.9 (New ID Format)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- C·∫§U H√åNH C∆† B·∫¢N --- */
        body, input, select, button, table, h1, h2, h3, p, span, div, textarea {
            font-family: Arial, sans-serif !important;
        }
        body { background-color: #e9ecef; margin: 0; padding: 20px; display: flex; gap: 20px; justify-content: center; align-items: flex-start; flex-wrap: wrap; }
        
        /* B·∫£ng ƒëi·ªÅu khi·ªÉn */
        .control-panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 480px; }
        .control-panel h2 { margin-top: 0; color: #333; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        .form-row { display: flex; gap: 10px; }
        .form-group { margin-bottom: 10px; flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #444; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .form-group input:focus { border-color: #007bff; outline: none; }

        .price-preview { color: #d35400; font-weight: bold; font-size: 13px; margin-top: 5px; display: block; text-align: right; }

        /* Input ƒë·ªông */
        #dynamicInputs { background: #f1f8ff; border: 1px solid #cce5ff; padding: 10px; border-radius: 5px; margin-bottom: 10px; max-height: 250px; overflow-y: auto; }
        .code-entry-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .code-entry-row span { font-size: 12px; font-weight: bold; width: 20px; }
        .code-entry-row input { font-size: 13px; padding: 6px; }

        /* Paste nhanh */
        .bulk-import-box { background: #fff3cd; border: 1px dashed #eba312; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .bulk-import-box textarea { width: 100%; height: 60px; border: 1px solid #ddd; font-size: 12px; resize: vertical; box-sizing: border-box; }
        .bulk-btn { background: #856404; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-top: 5px; }

        /* Buttons */
        .btn { width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; font-size: 13px; margin-top: 5px; }
        .btn-primary { background-color: #007bff; }
        .btn-warning { background-color: #f39c12; color: #fff; }
        .btn-success { background-color: #27ae60; }
        .btn-share { background-color: #6f42c1; }
        .btn-info { background-color: #17a2b8; }
        .btn-danger { background-color: #e74c3c; padding: 4px 8px; font-size: 12px; width: auto; margin-top: 0;}
        .btn-secondary { background-color: #6c757d; }
        .btn-excel { background-color: #217346; color: white; font-size: 12px; width: auto; padding: 5px 10px; margin-top: 0; }
        .btn:hover { opacity: 0.9; }
        .btn-group { display: flex; gap: 5px; margin-top: 15px; flex-wrap: wrap; }

        /* Payment Buttons */
        .payment-options { display: flex; gap: 10px; margin-bottom: 15px; }
        .pay-btn { flex: 1; padding: 8px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; border-radius: 5px; font-size: 13px; font-weight: bold; }
        .pay-btn.active { background: #007bff; color: white; border-color: #007bff; }
        
        /* Revenue & History */
        .revenue-box { margin-top: 20px; background: #2c3e50; color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .revenue-box h3 { margin: 0; font-size: 14px; font-weight: normal; color: #ccc; }
        .revenue-box .money { font-size: 24px; font-weight: bold; color: #2ecc71; display: block; margin: 5px 0; }
        
        .temp-list { margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px dashed #ccc; }
        .temp-item { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 5px 10px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #eee; font-size: 13px;}

        /* --- L·ªäCH S·ª¨ N√ÇNG CAO --- */
        .history-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .history-search { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; margin-bottom: 5px; box-sizing: border-box;}
        
        .history-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; background: #fff; border-radius: 5px; }
        .history-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .history-item:last-child { border-bottom: none; }
        
        .history-actions { display: flex; gap: 5px; }
        .btn-mini { padding: 3px 6px; font-size: 11px; border: none; border-radius: 3px; cursor: pointer; color: white; }
        .btn-edit { background-color: #f39c12; }
        .btn-del { background-color: #e74c3c; }

        /* --- H√ìA ƒê∆†N --- */
        .invoice-box { width: 80mm; background: white; padding: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.1); color: #000; font-size: 13px; box-sizing: border-box; line-height: 1.4; position: relative; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-bold { font-weight: bold; }
        .dashed-line { border-top: 1px dashed #000; margin: 10px 0; }
        .solid-line { border-top: 2px solid #000; margin: 10px 0; }
        .info-row { display: flex; justify-content: space-between; margin: 5px 0; }
        
        /* B·∫¢NG K·∫∫ √î */
        .bill-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; border: 1px solid #000; }
        .bill-table th { text-align: center; border: 1px solid #000; padding: 5px 2px; font-size: 11px; font-weight: bold; background-color: #eee; }
        .bill-table td { border: 1px solid #000; padding: 5px; vertical-align: middle; font-size: 12px; }

        .prod-name { font-weight: bold; display: block; margin-bottom: 2px; font-size: 13px; }
        .card-detail-line { display: block; font-size: 11px; color: #000; margin-top: 2px; border-bottom: 1px dotted #999; padding-bottom: 2px; font-family: 'Courier New', Courier, monospace; letter-spacing: 0px; }
        .card-detail-line:last-child { border-bottom: none; }

        .provisional-hidden .card-detail-line { display: none !important; }
        .provisional-hidden .hidden-msg { display: block !important; font-style: italic; color: #555; font-size: 11px; }
        .hidden-msg { display: none; }

        .qr-section { text-align: center; margin-top: 10px; display: none; }
        .qr-section img { width: 70%; max-width: 150px; height: auto; }
        .qr-note { font-size: 11px; margin-top: 5px; }

        @media print {
            body { background: white; padding: 0; margin: 0; visibility: hidden; }
            .control-panel, .revenue-box { display: none; }
            .invoice-box { visibility: visible; position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; padding: 0 5px; }
            @page { margin: 0; size: auto; }
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <h2>1. Th√¥ng tin ƒë∆°n h√†ng</h2>
        
        <div class="form-row">
            <div class="form-group">
                <label>M√£ Hƒê</label>
                <input type="text" id="inpInvoiceID" style="font-weight:bold; color:#d35400;" oninput="updateInvoiceHeader(); renderQR();">
            </div>
            <div class="form-group">
                <label>Ng√†y</label>
                <input type="date" id="inpDate" onchange="updateInvoiceHeader()">
            </div>
            <div class="form-group">
                <label>Gi·ªù</label>
                <input type="time" id="inpTime" onchange="updateInvoiceHeader()">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group" style="flex: 2;">
                <label>T√™n kh√°ch h√†ng</label>
                <input type="text" id="inpName" value="Kh√°ch l·∫ª" oninput="updateInvoiceHeader()">
            </div>
            <div class="form-group" style="flex: 1.5;">
                 <label>SƒêT</label>
                <input type="text" id="inpPhone" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateInvoiceHeader()" placeholder="09xxxxxxxx">
            </div>
        </div>

        <div class="dashed-line" style="border-color: #eee;"></div>

        <h2>2. Nh·∫≠p s·∫£n ph·∫©m</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Lo·∫°i th·∫ª</label>
                <select id="inpCardType" onchange="handleCardChange()"></select>
            </div>
            <div class="form-group">
                <label>M·ªánh gi√°</label>
                <select id="inpPriceSelect" onchange="calculateSellingPrice()"></select>
                <input type="number" id="inpPriceCustom" placeholder="Nh·∫≠p s·ªë ti·ªÅn..." style="display:none;" oninput="calculateSellingPrice()">
                <span id="sellingPricePreview" class="price-preview">Gi√° b√°n: 0 ƒë</span>
            </div>
        </div>
        
        <div class="bulk-import-box">
            <label style="font-size:12px; font-weight:bold; color:#856404;">üìã PASTE NHANH:</label>
            <textarea id="bulkArea" placeholder="V√≠ d·ª•: 11112222 [tab] 99998888"></textarea>
            <button type="button" class="bulk-btn" onclick="processBulkData()">‚ö° T·ª± ƒë·ªông ƒëi·ªÅn</button>
        </div>

        <div class="form-group">
            <label>S·ªë l∆∞·ª£ng:</label>
            <input type="number" id="inpQty" value="1" min="1" oninput="renderInputFields()">
        </div>

        <div id="dynamicInputs"></div>

        <button class="btn btn-warning" onclick="addToCart()">‚¨á TH√äM V√ÄO ƒê∆†N (Enter)</button>

        <div class="temp-list">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:bold; color:#555">DS Ch·ªù in:</span>
                <span id="itemCountBadge" style="background:#007bff; color:white; padding:2px 8px; border-radius:10px; font-size:12px;">0</span>
            </div>
            <div id="cartListUI"></div>
        </div>

        <div class="form-group" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top:10px;">
            <label style="color: #e74c3c;">üè∑Ô∏è Chi·∫øt kh·∫•u / Gi·∫£m gi√° (VNƒê):</label>
            <input type="number" id="inpDiscount" value="" placeholder="Nh·∫≠p s·ªë ti·ªÅn gi·∫£m..." oninput="renderAll()">
        </div>

        <div style="margin-top: 15px;">
            <label style="font-weight:bold; font-size:13px; margin-bottom:5px; display:block;">üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
            <div class="payment-options">
                <button class="pay-btn active" onclick="setPayment('CASH')" id="btnPayCash">üíµ Ti·ªÅn m·∫∑t</button>
                <button class="pay-btn" onclick="setPayment('MB')" id="btnPayMB">üè¶ MB Bank</button>
                <button class="pay-btn" onclick="setPayment('VP')" id="btnPayVP">üè¶ VP Bank</button>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="resetCart()" style="flex:1;">L√†m m·ªõi</button>
            <button class="btn btn-secondary" onclick="printProvisional()" style="flex:1;">üìÑ IN T·∫†M</button>
            <button class="btn btn-secondary" onclick="shareProvisionalImage()" style="flex:1; background-color: #607d8b;">üì§ SHARE T·∫†M</button>
        </div>
        <div class="btn-group" style="margin-top:5px;">
            <button class="btn btn-success" onclick="printOfficial()" style="flex:1.5;">üñ® IN CH√çNH TH·ª®C</button>
            <button class="btn btn-share" onclick="shareInvoiceImage()" style="flex:1;">üì§ CHIA S·∫∫</button>
            <button class="btn btn-info" onclick="downloadInvoiceImage()" style="flex:1;">‚¨á T·∫¢I V·ªÄ</button>
        </div>

        <div class="revenue-box">
            <h3>Doanh thu h√¥m nay</h3>
            <span class="money" id="dailyTotalDisplay">0 ƒë</span>
            <button class="btn-danger" onclick="resetDailyRevenue()" style="width: auto; padding: 5px 10px;">Ch·ªët ng√†y (Reset)</button>
        </div>

        <div class="history-section">
            <div class="history-header">
                <h3 style="font-size: 14px; margin: 0; color:#555;">üïí L·ªãch s·ª≠ ƒë∆°n h√†ng (Kh√¥ng gi·ªõi h·∫°n)</h3>
                <button class="btn btn-excel" onclick="exportHistoryToExcel()">üì• Xu·∫•t Excel</button>
            </div>
            
            <input type="text" id="inpSearchHistory" class="history-search" placeholder="üîç T√¨m ki·∫øm theo M√£ Hƒê ho·∫∑c SƒêT..." oninput="loadHistory()">

            <div class="history-list" id="historyListUI">
                <p style="padding:10px; color:#999; text-align:center;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
            </div>
        </div>
    </div>

    <div class="invoice-box" id="invoiceArea">
        <div class="text-center">
            <h3 style="margin: 5px 0 0 0; font-size: 20px; text-transform: uppercase; font-weight: 800; color: #000;">THE B√ÅO</h3>
            <p style="margin: 2px 0 5px 0; font-size: 13px; text-transform: uppercase; font-weight: bold;">D·ªãch v·ª• n·∫°p game tr·ª±c tuy·∫øn</p>
            <p style="margin: 2px 0;">Uy t√≠n - Nhanh ch√≥ng - B·∫£o m·∫≠t</p>
            <p style="margin: 2px 0; font-weight: bold;">‚òé 0354.830.400</p>
        </div>

        <div class="dashed-line"></div>

        <div class="text-center">
            <h2 style="margin: 5px 0; font-size: 16px;" id="lblInvoiceTitle">H√ìA ƒê∆†N B√ÅN H√ÄNG</h2>
            <p style="margin: 2px 0; font-weight:bold; font-size: 14px;" id="outInvoiceID">S·ªë: TB...</p> 
            <p style="margin: 0; font-size: 12px;" id="outDate">...</p>
        </div>

        <div class="dashed-line"></div>

        <div class="info-row">
            <span>Kh√°ch h√†ng:</span>
            <span id="outName" class="text-bold">Kh√°ch l·∫ª</span>
        </div>
        <div class="info-row" id="rowPhone" style="display:none;">
            <span>SƒêT:</span>
            <span id="outPhone">...</span>
        </div>

        <div class="solid-line"></div>

        <table class="bill-table">
            <thead>
                <tr>
                    <th style="width: 40%;">T√™n SP</th>
                    <th class="text-center" style="width: 15%;">SL</th>
                    <th class="text-center" style="width: 20%;">ƒê∆°n gi√°</th>
                    <th class="text-center" style="width: 25%;">T.Ti·ªÅn</th>
                </tr>
            </thead>
            <tbody id="invoiceTableBody"></tbody>
        </table>

        <div class="solid-line"></div>

        <div style="margin-top: 10px;">
            <div class="info-row" style="font-size: 13px;">
                <span>T·ªïng ti·ªÅn h√†ng:</span>
                <span id="outSubTotal">0</span>
            </div>
            <div class="info-row" style="font-size: 13px; display:none;" id="rowDiscount">
                <span>Chi·∫øt kh·∫•u:</span>
                <span id="outDiscountVal" style="color:#d35400;">0</span>
            </div>
            <div class="info-row" style="font-size: 16px; margin-top: 5px;">
                <span class="text-bold">THANH TO√ÅN:</span>
                <span id="outFinalTotal" class="text-bold">0</span>
            </div>
            <div class="info-row" style="font-size: 13px; margin-top: 5px; font-style: italic;">
                <span>H√¨nh th·ª©c TT:</span>
                <span id="outPaymentMethod">Ti·ªÅn m·∫∑t</span>
            </div>
        </div>

        <div class="qr-section" id="qrSection">
            <div class="dashed-line"></div>
            <p class="qr-note" style="font-weight:bold; margin-bottom:5px;">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n:</p>
            <img id="qrImage" src="" alt="QR Code">
            <p class="qr-note" id="qrBankName">Ng√¢n h√†ng MB</p>
            <p class="qr-note" id="qrAccNum">STK: 0354830400</p>
        </div>
        
        <div class="dashed-line"></div>

        <div class="footer text-center" style="margin-top: 15px; font-style: italic; font-size: 12px;">
            <p style="margin: 3px;">C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•!</p>
            <p style="margin: 3px;">H·ªó tr·ª£ / Khi·∫øu n·∫°i Zalo: 0354.830.400</p>
        </div>
    </div>

    <script>
        const cardsData = {
            "Garena": [5000, 10000, 20000, 50000, 100000, 200000, 500000],
            "Gate": [20000, 50000, 100000, 200000, 500000, 1000000, 2000000, 5000000, 10000000],
            "Oncash": [20000, 50000, 100000, 200000, 500000],
            "Zing": [20000, 50000, 100000, 200000, 500000, 1000000],
            "Vcoin": [20000, 50000, 100000, 200000, 500000, 1000000, 5000000],
            "Kul": [20000, 50000, 100000, 200000, 500000, 1000000, 2000000],
            "Funcard": [20000, 50000, 100000, 200000, 500000, 1000000, 2000000],
            "Coin": [20000, 50000, 100000, 200000, 500000, 1000000],
            "Appota Card": [20000, 50000, 100000, 200000, 500000, 1000000, 2000000],
            "iSec": [20000, 50000, 100000, 200000, 500000, 1000000, 2000000, 5000000, 10000000],
            "Gosu": [20000, 50000, 100000, 200000, 500000, 1000000],
            "9play": [20000, 50000, 100000, 200000, 500000, 1000000, 2000000],
            "Sohacoin": [20000, 50000, 100000, 200000, 500000, 1000000, 2000000, 5000000, 10000000],
            "Viettel": [], "Vinaphone": [10000, 20000, 50000, 100000, 200000, 500000],
            "Mobifone": [10000, 20000, 50000, 100000, 200000, 500000],
            "Vietnamobile": [20000, 50000, 100000, 200000, 500000],
            "Gmobile": [50000, 100000, 200000, 500000],
            "Steam": [75000, 100000, 120000, 150000, 200000, 500000],
            "Google Play": []
        };

        let cartItems = []; 
        let currentPaymentMethod = 'CASH';
        
        const cardSelect = document.getElementById('inpCardType');
        const priceSelect = document.getElementById('inpPriceSelect');
        const priceCustom = document.getElementById('inpPriceCustom');
        const pricePreview = document.getElementById('sellingPricePreview');
        const discountInput = document.getElementById('inpDiscount');
        const formatMoney = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        const formatReadableCode = (code) => code ? code.replace(/\s+/g, '').replace(/(.{4})/g, '$1 ').trim() : "";

        function init() {
            for (let card in cardsData) {
                let option = document.createElement("option");
                option.value = card;
                option.text = card;
                cardSelect.appendChild(option);
            }
            const now = new Date();
            document.getElementById('inpTime').value = now.toTimeString().substring(0,5);
            document.getElementById('inpDate').valueAsDate = now;
            generateRandomInvoiceID();
            handleCardChange(); 
            updateInvoiceHeader();
            renderInputFields();
            loadDailyRevenue();
            loadHistory();
            document.addEventListener('keydown', function(event) {
                if (event.key === "Enter" && (document.activeElement.tagName === 'INPUT')) addToCart();
            });
        }

        function setPayment(method) {
            currentPaymentMethod = method;
            document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btnPay${method}`).classList.add('active');
            const methodText = method === 'CASH' ? 'Ti·ªÅn m·∫∑t' : (method === 'MB' ? 'Chuy·ªÉn kho·∫£n MB' : 'Chuy·ªÉn kho·∫£n VP');
            document.getElementById('outPaymentMethod').innerText = methodText;
            renderQR();
        }

        function renderQR() {
            const qrSection = document.getElementById('qrSection');
            if (currentPaymentMethod === 'CASH') { qrSection.style.display = 'none'; return; }
            let totalBill = cartItems.reduce((s, i) => s + i.total, 0);
            let discount = parseInt(discountInput.value) || 0;
            let finalTotal = totalBill - discount;
            if (finalTotal <= 0) { qrSection.style.display = 'none'; return; }

            qrSection.style.display = 'block';
            const bankID = currentPaymentMethod === 'MB' ? 'MB' : 'VPB';
            const accNum = '0354830400';
            const invID = document.getElementById('inpInvoiceID').value;
            const content = "Thanh toan " + invID; 
            const safeContent = encodeURIComponent(content);
            document.getElementById('qrBankName').innerText = currentPaymentMethod === 'MB' ? 'Ng√¢n h√†ng Qu√¢n ƒê·ªôi (MB)' : 'Ng√¢n h√†ng VPBank';
            const qrUrl = `https://img.vietqr.io/image/${bankID}-${accNum}-compact.png?amount=${finalTotal}&addInfo=${safeContent}`;
            document.getElementById('qrImage').src = qrUrl;
        }

        function handleCardChange() {
            const selectedCard = cardSelect.value;
            const prices = cardsData[selectedCard];
            if (prices.length === 0) {
                priceSelect.style.display = "none";
                priceCustom.style.display = "block";
                priceCustom.value = "";
                priceCustom.focus();
            } else {
                priceSelect.style.display = "block";
                priceCustom.style.display = "none";
                priceSelect.innerHTML = "";
                prices.forEach(price => {
                    let option = document.createElement("option");
                    option.value = price;
                    option.text = formatMoney(price);
                    priceSelect.appendChild(option);
                });
            }
            calculateSellingPrice();
        }

        function calculateSellingPrice() {
            const cardType = cardSelect.value;
            let faceValue = 0; 
            if (cardsData[cardType].length === 0) faceValue = parseInt(priceCustom.value) || 0;
            else faceValue = parseInt(priceSelect.value) || 0;
            let sellingPrice = faceValue;
            if (cardType === "Steam") sellingPrice = faceValue + (faceValue * 0.20); 
            else if (cardType === "Google Play") sellingPrice = faceValue + (faceValue * 0.04); 
            pricePreview.innerText = `Gi√° b√°n: ${formatMoney(sellingPrice)} ƒë`;
            return { faceValue, sellingPrice };
        }

        function addToCart() {
            const cardType = cardSelect.value;
            const qty = parseInt(document.getElementById('inpQty').value);
            const { faceValue, sellingPrice } = calculateSellingPrice();
            if (faceValue <= 0) return alert("Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p m·ªánh gi√° h·ª£p l·ªá!");
            if (qty < 1) return alert("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0");
            let cardList = [];
            const codeInputs = document.querySelectorAll('.sub-code');
            const serialInputs = document.querySelectorAll('.sub-serial');
            for(let i=0; i<qty; i++) {
                cardList.push({ code: codeInputs[i].value.trim(), serial: serialInputs[i].value.trim() });
            }
            cartItems.push({ cardType, faceValue, price: sellingPrice, qty, cardList, total: sellingPrice * qty });
            renderAll();
            document.getElementById('inpQty').value = 1;
            renderInputFields();
            if (priceCustom.style.display !== 'none') { priceCustom.value = ""; priceCustom.focus(); } 
            else { if(document.querySelector('.sub-code')) document.querySelector('.sub-code').focus(); }
            calculateSellingPrice(); 
        }

        function processBulkData() {
            const raw = document.getElementById('bulkArea').value;
            if(!raw.trim()) return alert("H√£y d√°n m√£ th·∫ª v√†o √¥!");
            const lines = raw.trim().split(/\n/);
            document.getElementById('inpQty').value = lines.length;
            renderInputFields();
            const codeInputs = document.querySelectorAll('.sub-code');
            const serialInputs = document.querySelectorAll('.sub-serial');
            lines.forEach((line, index) => {
                if(index >= codeInputs.length) return;
                let parts = line.trim().split(/[\t|]+/); 
                if(parts.length === 1) parts = line.trim().split(/\s+/);
                if(parts.length >= 1) codeInputs[index].value = parts[0].trim();
                if(parts.length >= 2) serialInputs[index].value = parts[1].trim();
            });
            document.getElementById('bulkArea').value = "";
        }

        function renderInputFields() {
            const qty = parseInt(document.getElementById('inpQty').value) || 1;
            const container = document.getElementById('dynamicInputs');
            let currentData = [];
            document.querySelectorAll('.sub-code').forEach((el, i) => {
                currentData.push({ c: el.value, s: document.querySelectorAll('.sub-serial')[i]?.value || '' });
            });
            container.innerHTML = "";
            for(let i = 0; i < qty; i++) {
                let row = document.createElement('div');
                row.className = 'code-entry-row';
                let valC = currentData[i] ? currentData[i].c : '';
                let valS = currentData[i] ? currentData[i].s : '';
                row.innerHTML = `<span>#${i+1}</span><input type="text" class="sub-code" value="${valC}" placeholder="M√£ th·∫ª" style="flex:1"><input type="text" class="sub-serial" value="${valS}" placeholder="Seri" style="flex:1">`;
                container.appendChild(row);
            }
        }

        // --- UPDATED ID GENERATOR ---
        function generateRandomInvoiceID() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let randomPart = "";
            for (let i = 0; i < 5; i++) {
                randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('inpInvoiceID').value = "TB" + randomPart;
            updateInvoiceHeader();
            renderQR();
        }

        function updateInvoiceHeader() {
            const name = document.getElementById('inpName').value;
            const phone = document.getElementById('inpPhone').value;
            const dateVal = document.getElementById('inpDate').value; 
            let dateStr = dateVal ? `${dateVal.split('-')[2]}/${dateVal.split('-')[1]}/${dateVal.split('-')[0]}` : "...";
            let invoiceCode = document.getElementById('inpInvoiceID').value.toUpperCase();
            if (!invoiceCode.startsWith("TB")) invoiceCode = "TB" + invoiceCode;
            document.getElementById('outDate').innerText = `Ng√†y: ${dateStr} - Gi·ªù: ${document.getElementById('inpTime').value}`;
            document.getElementById('outName').innerText = name || "Kh√°ch l·∫ª";
            document.getElementById('outInvoiceID').innerText = "S·ªë: " + invoiceCode;
            const phoneRow = document.getElementById('rowPhone');
            if(phone) { document.getElementById('outPhone').innerText = phone; phoneRow.style.display = "flex"; } 
            else { phoneRow.style.display = "none"; }
        }

        function removeItem(index) { cartItems.splice(index, 1); renderAll(); }
        function resetCart() { if(confirm("T·∫°o ƒë∆°n m·ªõi?")) { cartItems = []; generateRandomInvoiceID(); document.getElementById('inpName').value = "Kh√°ch l·∫ª"; document.getElementById('inpPhone').value = ""; document.getElementById('inpDiscount').value = ""; document.getElementById('inpDate').valueAsDate = new Date(); renderAll(); } }
        function loadDailyRevenue() { const saved = localStorage.getItem('gameCardRevenue'); if(saved) document.getElementById('dailyTotalDisplay').innerText = formatMoney(parseInt(saved)) + " ƒë"; }
        function updateDailyRevenue(amount) { let cur = parseInt(localStorage.getItem('gameCardRevenue')) || 0; cur += amount; localStorage.setItem('gameCardRevenue', cur); document.getElementById('dailyTotalDisplay').innerText = formatMoney(cur) + " ƒë"; }
        function resetDailyRevenue() { if(confirm("Ch·ªët ng√†y v√† Reset v·ªÅ 0?")) { localStorage.setItem('gameCardRevenue', 0); document.getElementById('dailyTotalDisplay').innerText = "0 ƒë"; } }
        
        function printProvisional() {
            document.getElementById('invoiceArea').classList.add('provisional-hidden');
            const originalTitle = document.getElementById('lblInvoiceTitle').innerText;
            document.getElementById('lblInvoiceTitle').innerText = "H√ìA ƒê∆†N T·∫†M T√çNH";
            setTimeout(() => {
                window.print();
                document.getElementById('invoiceArea').classList.remove('provisional-hidden');
                document.getElementById('lblInvoiceTitle').innerText = originalTitle;
            }, 500);
        }

        function printOfficial() {
            document.getElementById('invoiceArea').classList.remove('provisional-hidden');
            document.getElementById('lblInvoiceTitle').innerText = "H√ìA ƒê∆†N B√ÅN H√ÄNG";
            let totalBill = cartItems.reduce((s, i) => s + i.total, 0);
            let discount = parseInt(discountInput.value) || 0;
            let finalTotal = totalBill - discount;
            if(finalTotal > 0) {
                updateDailyRevenue(finalTotal);
                saveHistory();
            }
            window.print();
        }

        function exportHistoryToExcel() {
            let history = JSON.parse(localStorage.getItem('invoiceHistory') || "[]");
            if(history.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu l·ªãch s·ª≠ ƒë·ªÉ xu·∫•t!");
            let csvContent = "\uFEFF";
            csvContent += "M√£ Hƒê,Ng√†y,Gi·ªù,Kh√°ch h√†ng,SƒêT,Thanh to√°n,Chi·∫øt kh·∫•u,T·ªïng ti·ªÅn,Chi ti·∫øt s·∫£n ph·∫©m\n";
            history.forEach(h => {
                let details = h.cart.map(i => {
                    let displayPrice = i.faceValue >= 1000 ? (i.faceValue/1000) + 'k' : i.faceValue;
                    return `${i.cardType} ${displayPrice} (x${i.qty})`;
                }).join("; ");
                let row = [
                    h.id, h.date, h.time, h.name, "'" + h.phone, 
                    h.payment, h.discount, h.total, details
                ].map(e => `"${e}"`).join(","); 
                csvContent += row + "\n";
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "LichSu_DonHang_TheBao.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- CORE FUNCTION: SAVE / EDIT / SEARCH / DELETE ---

        function saveHistory() {
            if(cartItems.length === 0) return;
            const currentID = document.getElementById('inpInvoiceID').value;
            const historyItem = {
                id: currentID,
                date: document.getElementById('inpDate').value,
                time: document.getElementById('inpTime').value,
                name: document.getElementById('inpName').value,
                phone: document.getElementById('inpPhone').value,
                discount: document.getElementById('inpDiscount').value,
                payment: currentPaymentMethod,
                cart: JSON.parse(JSON.stringify(cartItems)), 
                total: parseInt(document.getElementById('outFinalTotal').innerText.replace(/\D/g, ''))
            };
            
            let history = JSON.parse(localStorage.getItem('invoiceHistory') || "[]");
            
            // Logic C·∫≠p nh·∫≠t: N·∫øu ID ƒë√£ t·ªìn t·∫°i -> Ghi ƒë√® (S·ª≠a). N·∫øu ch∆∞a -> Th√™m m·ªõi.
            let existingIndex = history.findIndex(h => h.id === currentID);
            
            if (existingIndex !== -1) {
                history[existingIndex] = historyItem; // C·∫≠p nh·∫≠t
            } else {
                history.unshift(historyItem); // Th√™m m·ªõi v√†o ƒë·∫ßu
            }

            // ƒê√£ x√≥a gi·ªõi h·∫°n 100 ƒë∆°n
            localStorage.setItem('invoiceHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const listUI = document.getElementById('historyListUI');
            const keyword = document.getElementById('inpSearchHistory').value.toLowerCase();
            let history = JSON.parse(localStorage.getItem('invoiceHistory') || "[]");
            
            // L·ªçc theo t·ª´ kh√≥a (M√£ Hƒê ho·∫∑c SƒêT)
            if(keyword) {
                history = history.filter(h => 
                    h.id.toLowerCase().includes(keyword) || 
                    (h.phone && h.phone.includes(keyword))
                );
            }

            if(history.length === 0) {
                listUI.innerHTML = '<p style="padding:10px; color:#999; text-align:center;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng.</p>';
                return;
            }

            let html = '';
            history.forEach((h) => {
                html += `<div class="history-item">
                    <div style="flex:1">
                        <strong>${h.id}</strong> - ${h.name} <br>
                        <span style="color:#666">${h.date} ${h.time} | ${h.payment}</span>
                    </div>
                    <div class="text-right">
                        <strong style="color:#27ae60">${formatMoney(h.total)} ƒë</strong><br>
                        <div class="history-actions" style="justify-content: flex-end; margin-top:3px;">
                             <button class="btn-mini btn-edit" onclick="restoreHistory('${h.id}')">‚úè S·ª≠a</button>
                             <button class="btn-mini btn-del" onclick="deleteHistory('${h.id}')">üóë X√≥a</button>
                        </div>
                    </div>
                </div>`;
            });
            listUI.innerHTML = html;
        }

        function restoreHistory(id) {
            let history = JSON.parse(localStorage.getItem('invoiceHistory') || "[]");
            let h = history.find(item => item.id === id);
            
            if(h) {
                if(!confirm("B·∫°n mu·ªën s·ª≠a ƒë∆°n h√†ng " + id + "?\n(D·ªØ li·ªáu hi·ªán t·∫°i tr√™n m√†n h√¨nh s·∫Ω b·ªã thay th·∫ø)")) return;
                document.getElementById('inpInvoiceID').value = h.id;
                document.getElementById('inpDate').value = h.date;
                document.getElementById('inpTime').value = h.time;
                document.getElementById('inpName').value = h.name;
                document.getElementById('inpPhone').value = h.phone;
                document.getElementById('inpDiscount').value = h.discount;
                cartItems = h.cart;
                setPayment(h.payment || 'CASH');
                renderAll();
                alert("ƒê√£ t·∫£i l·∫°i ƒë∆°n h√†ng ƒë·ªÉ s·ª≠a. \nSau khi s·ª≠a xong, nh·∫•n 'IN CH√çNH TH·ª®C' ƒë·ªÉ c·∫≠p nh·∫≠t.");
            }
        }

        function deleteHistory(id) {
            if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn ƒë∆°n h√†ng " + id + "?")) return;
            let history = JSON.parse(localStorage.getItem('invoiceHistory') || "[]");
            let newHistory = history.filter(h => h.id !== id);
            localStorage.setItem('invoiceHistory', JSON.stringify(newHistory));
            loadHistory();
        }

        function downloadInvoiceImage() {
            const invoice = document.getElementById('invoiceArea');
            const originalShadow = invoice.style.boxShadow;
            invoice.style.boxShadow = "none"; invoice.style.border = "1px solid #ccc";
            html2canvas(invoice, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'HoaDon_' + document.getElementById('inpInvoiceID').value + '.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                invoice.style.boxShadow = originalShadow; invoice.style.border = "none";
            });
        }

        function shareInvoiceImage() {
            const invoice = document.getElementById('invoiceArea');
            const originalShadow = invoice.style.boxShadow;
            invoice.style.boxShadow = "none"; invoice.style.border = "1px solid #ccc";
            html2canvas(invoice, { scale: 2 }).then(canvas => {
                canvas.toBlob(blob => {
                    const file = new File([blob], "HoaDon.png", { type: "image/png" });
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({ files: [file], title: 'H√≥a ƒë∆°n', text: 'G·ª≠i b·∫°n h√≥a ƒë∆°n.' })
                        .catch(err => console.log(err));
                    } else {
                        alert("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ Share. T·∫£i ·∫£nh v·ªÅ m√°y.");
                        const link = document.createElement('a');
                        link.download = 'HoaDon_' + document.getElementById('inpInvoiceID').value + '.png';
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    }
                });
                invoice.style.boxShadow = originalShadow; invoice.style.border = "none";
            });
        }

        function shareProvisionalImage() {
            const invoice = document.getElementById('invoiceArea');
            const originalShadow = invoice.style.boxShadow;
            const originalTitle = document.getElementById('lblInvoiceTitle').innerText;
            invoice.style.boxShadow = "none"; invoice.style.border = "1px solid #ccc";
            invoice.classList.add('provisional-hidden');
            document.getElementById('lblInvoiceTitle').innerText = "H√ìA ƒê∆†N T·∫†M T√çNH";
            html2canvas(invoice, { scale: 2 }).then(canvas => {
                canvas.toBlob(blob => {
                    const file = new File([blob], "HoaDon_TamTinh.png", { type: "image/png" });
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({ files: [file], title: 'H√≥a ƒë∆°n t·∫°m', text: 'G·ª≠i b·∫°n h√≥a ƒë∆°n t·∫°m t√≠nh.' })
                        .catch(err => console.log(err));
                    } else {
                        alert("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ Share. T·∫£i ·∫£nh v·ªÅ m√°y.");
                        const link = document.createElement('a');
                        link.download = 'HoaDon_TamTinh_' + document.getElementById('inpInvoiceID').value + '.png';
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    }
                });
                invoice.style.boxShadow = originalShadow; invoice.style.border = "none";
                invoice.classList.remove('provisional-hidden');
                document.getElementById('lblInvoiceTitle').innerText = originalTitle;
            });
        }

        function renderAll() {
            const listContainer = document.getElementById('cartListUI');
            const tbody = document.getElementById('invoiceTableBody');
            document.getElementById('itemCountBadge').innerText = cartItems.length;

            if (cartItems.length === 0) listContainer.innerHTML = '<p style="color:#999;font-style:italic;text-align:center;">Ch∆∞a c√≥ s·∫£n ph·∫©m.</p>';
            else {
                let html = '';
                cartItems.forEach((item, index) => {
                    let displayPrice = item.faceValue >= 1000 ? (item.faceValue/1000) + 'k' : item.faceValue;
                    html += `<div class="temp-item"><div><strong>${index+1}. ${item.cardType} ${displayPrice}</strong> (B√°n: ${formatMoney(item.price)}) x${item.qty}</div><button class="btn btn-danger" onclick="removeItem(${index})">X</button></div>`;
                });
                listContainer.innerHTML = html;
            }

            updateInvoiceHeader();
            let totalBill = 0;
            let invHtml = '';
            cartItems.forEach((item) => {
                totalBill += item.total;
                let faceLabel = item.faceValue >= 1000 ? (item.faceValue / 1000) + 'k' : item.faceValue;
                let fullName = `${item.cardType} ${faceLabel}`;
                invHtml += `<tr><td colspan="4" style="padding: 5px; background-color:#fcfcfc;"><span class="prod-name">${fullName}</span></td></tr>`;
                let detailsHtml = '';
                item.cardList.forEach(c => {
                    if(!c.code && !c.serial) return;
                    detailsHtml += `
                        <div class="card-detail-line">
                            ${c.code ? `M√£: <b>${formatReadableCode(c.code)}</b>` : ''} ${c.serial ? ` | Seri: ${c.serial}` : ''}
                        </div>
                        <span class="hidden-msg">(*M√£ th·∫ª ƒë√£ ·∫©n*)</span>
                    `;
                });
                invHtml += `<tr>
                    <td style="vertical-align: top;">${detailsHtml || '<span style="font-size:11px; color:#999">...</span>'}</td>
                    <td class="text-center" style="vertical-align: top;">${item.qty}</td>
                    <td class="text-right" style="vertical-align: top;">${formatMoney(item.price)}</td>
                    <td class="text-right" style="vertical-align: top;">${formatMoney(item.total)}</td>
                </tr>`;
            });
            tbody.innerHTML = invHtml;
            
            const discountVal = parseInt(discountInput.value) || 0;
            const finalTotal = totalBill - discountVal;
            document.getElementById('outSubTotal').innerText = formatMoney(totalBill) + " ƒë";
            if(discountVal > 0) {
                document.getElementById('rowDiscount').style.display = "flex";
                document.getElementById('outDiscountVal').innerText = "-" + formatMoney(discountVal) + " ƒë";
            } else {
                document.getElementById('rowDiscount').style.display = "none";
            }
            document.getElementById('outFinalTotal').innerText = formatMoney(finalTotal) + " ƒë";
            renderQR();
        }

        init();
    </script>
</body>
</html>
